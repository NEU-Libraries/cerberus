<header>
  <h1 class="page-header">
    Create a new Sentinel
  </h1>
</header>

<%= form_for @sentinel, url: {action: "create"} do |f| %>
  <% if params[:parent].present? %>
  <%= f.hidden_field :set_pid, :value => params[:parent] %>
  <% end %>


  <div>
    <h3>
      Core File
    </h3>
    <% if !@collection %>
      Enable <%= check_box_tag "core_file_checkbox" %>
    <% end %>

    <div class="row-fluid core_file">
      <fieldset class="span6">

        <legend>Mass Permissions</legend>
        <% if @collection %>
          <%= label_tag 'core_file[mass_permissions]', "Choose Mass Permissions:", class: "required-label" %>
        <% else %>
          <%= label_tag 'core_file[mass_permissions]', "Choose Mass Permissions:" %>
        <% end %>
        <%= select_tag 'core_file[mass_permissions]', options_for_select(['public', 'private'], 'public') , class: "span6", disabled: true %>
        <p class="help-block">
          <ul>
            <li>Setting to 'public' will allow anyone accessing the site to see your item.</li>
            <li>Setting to 'private' will only allow groups explicitly chosen to see your item.</li>
          </ul>
        </p>
      </fieldset>
      <fieldset class="span6">
        <legend>Permissions</legend>
        <%= render partial: 'shared/sets/data_form_permissions_element', locals: {:f => f, :array_type => "core_file", :permissions => [] } %>
        <button class="btn btn-success btn-block" id="add_another_permission" type="button">
          <i class="icon-plus-sign icon-large"></i>
          Add Permission
        </button>
      </fieldset>
    </div>
  </div>

  <hr>

  <h3>
    Content Objects
  </h3>

  <div>
    <% @content_list.each_with_index do |a, i| %>
      <% if i.even? %>
        </div>
        <div class="row-fluid">
      <% end %>
        <fieldset class="span6">
          <legend>
            <%= "#{a[0]}" %>
          </legend>
          Enable <%= check_box_tag "#{a[1]}_checkbox" %>
          <br/>
          <br/>

          <%= label_tag "sentinel[#{a[1]}][mass_permissions]", "Choose Mass Permissions:" %>
          <%= select_tag "sentinel[#{a[1]}][mass_permissions]", options_for_select(['public', 'private'], 'public') , class: "span6" %>

          <div class="permission<%= i %>">
            <%= f.label :identity, "Select Group" %>
            <% options = {"" => ""} %>
            <%= select_tag "sentinel[#{a[1]}][permissions][identity][]", options_for_select(current_user.pretty_groups), class: "span12", prompt: "-- Select Group --" %>
            <%= label_tag "sentinel[#{a[1]}][permissions][permission_type][]", "Should this identity be allowed to read or edit?" %>
            <div style="display: block;">
              <%= select_tag "sentinel[#{a[1]}][permissions][permission_type][]", options_for_select(['read', 'edit']), class: "span12" %>
            </div>
          </div>
          <button class="btn btn-success btn-block" id="add_another_permission<%= i %>" type="button">
            <i class="icon-plus-sign icon-large"></i>
            Add Permission
          </button>
        </fieldset>
        <script>

          $('#add_another_permission<%= i %>').addFormFields({
            target: $('#add_another_permission<%= i %>').siblings('div:not(.to-remove)'),
            titleText: 'Remove permission'
          });

        </script>
        <% if i == @content_list.length - 1 %>
          </div>
        <% end %>
        <% next %>
        <fieldset class="span6">
          <legend>
            <%= "#{a[0]}" %>
          </legend>
          Enable <%= check_box_tag "#{a[1]}_checkbox" %>
          <br/>
          <br/>

          <%= label_tag "sentinel[#{a[1]}][mass_permissions]", "Choose Mass Permissions:" %>
          <%= select_tag "sentinel[#{a[1]}][mass_permissions]", options_for_select(['public', 'private'], 'public') , class: "span6" %>

          <div class="permission<%= i %>">
            <%= f.label :identity, "Select Group" %>
            <% options = {"" => ""} %>
            <%= select_tag "sentinel[#{a[1]}][permissions][identity][]", options_for_select(current_user.pretty_groups), class: "span12", prompt: "-- Select Group --" %>
            <%= label_tag "sentinel[#{a[1]}][permissions][permission_type][]", "Should this identity be allowed to read or edit?" %>
            <div style="display: block;">
              <%= select_tag "sentinel[#{a[1]}][permissions][permission_type][]", options_for_select(['read', 'edit']), class: "span12" %>
            </div>
          </div>
          <button class="btn btn-success btn-block" id="add_another_permission<%= i %>" type="button">
            <i class="icon-plus-sign icon-large"></i>
            Add Permission
          </button>
        </fieldset>
        <script>

          $('#add_another_permission<%= i %>').addFormFields({
            target: $('#add_another_permission<%= i %>').siblings('div:not(.to-remove)'),
            titleText: 'Remove permission'
          });

        </script>
      </div>
    <% end %>

    <div class="form-actions">
      <%= f.submit class: ['btn', 'btn-primary'], value: 'Submit', data: { disable_with: "Please wait..."} %>
      <a class="btn btn-warning" href="#cancelEditModal" data-toggle="modal" >
        Cancel
      </a>
    </div>

  <% end %>

<%= render partial: 'shared/cancel_edit_modal', locals: { item: @set } %>

<script>
  $(document).ready(function () {
    $('fieldset').find('select, button').prop('disabled', true);
  });

  $(document).ready(function () {
  	$("input:checkbox").click(function () {
  		if($(this).is(':checked')) {
  			$(this).parent().find('*:disabled').removeAttr("disabled");
  		} else {
  			$(this).parent().find('select, button').prop('disabled', true);
  		}
  	});
  });
</script>

<% if @collection %>
  <script>
    $(document).ready(function () {
      $("#core_file_mass_permissions").prop('required', true);
      $("div.core_file").find('*:disabled').removeAttr("disabled");
    });
  </script>
<% end %>
